javascript:(function(){
function showToast(t,e=3000){
  if(!document.getElementById("mobile-toast-container")){
    const c=document.createElement("div");
    c.id="mobile-toast-container";
    c.style="position:fixed;top:15px;left:50%;transform:translateX(-50%);z-index:99999;max-width:320px;text-align:center";
    document.body.appendChild(c);
  }
  const o=document.createElement("div");
  o.textContent=t;
  o.style="background:#333;color:#fff;padding:8px 12px;margin-top:8px;border-radius:8px;cursor:pointer;font-size:13px;display:inline-block;box-shadow:0 2px 6px rgba(0,0,0,.3)";
  o.onclick=()=>o.remove();
  document.getElementById("mobile-toast-container").appendChild(o);
  e>0&&setTimeout(()=>o.remove(),e);
}

function sendSocketPayload(cmd,data){
  if(typeof window._realSocket_==="undefined"||window._realSocket_.readyState!==1){
    console.warn("âš  Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ WebSocket Ø¬Ø§Ù‡Ø²");
    return false;
  }
  try{
    window._realSocket_.send("42"+JSON.stringify(["msg",{cmd,data}])); 
    return true;
  }catch(e){
    console.error("âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:",e);
    return false;
  }
}

// ğŸŸ¢ Ù†Ø¸Ø§Ù… Ø§Ù„Ø±ÙˆÙ… Ù…Ù† Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø£ÙˆÙ„
const userRoomMap = {};
const roomNames = {};

if(window._realSocket_){
  window._realSocket_.addEventListener("message",function(event){
    try{
      const data=event.data;
      if(typeof data==="string"&&data.startsWith("42")){
        const payload=JSON.parse(data.slice(2));
        const [eventName,content]=payload;
        if(eventName==="msg"&&content?.cmd==="wr"&&Array.isArray(content.data)){
          const [userId,roomId]=content.data;
          userRoomMap[userId]=roomId;
          const roomEl=document.querySelector(`.room.r${roomId}`);
          const roomName=roomEl?.querySelector(".u-topic")?.textContent.trim();
          if(roomName) roomNames[roomId]=roomName;
        }
      }
    }catch(e){}
  });
}

// ğŸŸ¢ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ø­Ø¯ÙŠØ«Ø©
function bindProfileElement(el){
  const status=el.querySelector('img[src*="s4.png"]'),
        uid=[...el.classList].find(c=>c.startsWith("uid"));
  if(status&&uid){
    el.style.cursor="pointer";
    el.onclick=()=>{
      const id=uid.replace("uid","");
      const topic=el.querySelector(".u-topic")?.textContent.trim()||"";
      const picDiv=el.querySelector(".u-pic");
      const rawBg=picDiv?.style.backgroundImage || "";
      const bgImg=rawBg.replace(/^url\(["']?|["']?\)$/g,"").trim()
        .replace(/\.png\.png$/, ".png")
        .replace(/\.jpg\.png$/, ".jpg")
        .replace(/\.jpeg\.png$/, ".jpeg");
      window.cpShowProfile?.show ? window.cpShowProfile.show(id,topic,bgImg) : alert("Ù†Ø§ÙØ°Ø© Ø´Ùˆ Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„Ø© Ø¨Ø¹Ø¯");
    };
  }
}

if(!document.getElementById("cp-showprofile-modal")){
  const style=document.createElement("style");
  style.textContent=`
  #cp-showprofile-modal {position:fixed;z-index:100000;top:50%;left:50%;transform:translate(-50%,-50%);background:#0b4c4d;color:#fff;border-radius:6px;box-shadow:0 0 25px rgba(0,0,0,.5);width:340px;max-width:95%;font-family:Arial;overflow:hidden;display:none;}
  #cp-sp-header {background:#008c8d;color:white;padding:6px 10px;display:flex;align-items:center;justify-content:space-between;font-weight:bold;font-size:15px;}
  .modal-title {display:flex;align-items:center;gap:6px;max-width:90%;overflow:hidden;}
  #cp-user-ico {height:18px;object-fit:contain;flex-shrink:0;}
  #cp-user-banner {height:30px;object-fit:contain;flex-shrink:0;}
  #cp-user-name {font-weight:bold;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .cp-sp-close {cursor:pointer;background:none;border:none;color:#fff;font-size:18px;}
  #cp-user-pic {width:100%;height:200px;background-size:contain;background-repeat:no-repeat;background-position:50% 50%;border-bottom:1px solid rgba(255,255,255,.1);}
  #cp-user-pic-inner {width:100%;height:100%;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);background-size:contain;background-repeat:no-repeat;background-position:50% 50%;}
  #cp-user-msg {text-align:center;padding:6px 8px;color:#ddd;border-bottom:1px solid rgba(255,255,255,.1);font-size:13px;}
  #cp-action-box {padding:10px;display:flex;gap:8px;justify-content:space-between;}
  .cp-sp-btn {flex:1;background:#17171b;border:1px solid rgba(255,255,255,.05);color:#fff;padding:10px;border-radius:6px;text-align:center;cursor:pointer;font-size:14px;}
  .cp-sp-btn:hover {background:#262629;}
  .cp-sp-btn.active {background:#1a73e8;font-weight:bold;}
  #cp-sp-notify-box {display:none;padding:10px;border-top:1px solid rgba(255,255,255,.05);}
  #cp-room-box{
  text-align: right !important;
  display: flex !important;
  justify-content: flex-end !important;
  align-items: center !important;
}
  #cp-room-box div {padding:4px 22px;background:#5c3a1e;color:#fff;border-radius:5px;font-size:12px;display:flex;align-items:center;gap:4px;cursor:pointer;}
  #cp-room-box img {max-width:24px;border-radius:4px;}
  `;
  document.head.appendChild(style);

  const modal=document.createElement("div");
  modal.id="cp-showprofile-modal";
  modal.innerHTML=`
    <div id="cp-sp-header">
      <span class="modal-title">
        <img id="cp-user-ico">
        <img id="cp-user-banner" class="fl u-ico" alt="">
        <span id="cp-user-name"></span>
      </span>
      <button class="cp-sp-close">Ã—</button>
    </div>
    <div id="cp-user-pic" class="fl u-pic fitimg"><div id="cp-user-pic-inner" class="bgf fl u-pic fitimg"></div></div>
    <div id="cp-user-msg"></div>
    <div id="cp-room-box"></div>
    <div id="cp-action-box">
      <div class="cp-sp-btn" id="cp-sp-private">Ù…Ø­Ø§Ø¯Ø«Ø©</div>
      <div class="cp-sp-btn" id="cp-sp-notify">ØªÙ†Ø¨ÙŠÙ‡</div>
      <div class="cp-sp-btn" id="cp-sp-like">Ø¥Ø¹Ø¬Ø§Ø¨</div>
    </div>
    <div id="cp-sp-notify-box">
      <textarea id="cp-sp-notify-txt" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ù†Ø§..." style="width:100%;height:70px;background:#0b0b0d;color:white;border-radius:6px;padding:8px;border:1px solid rgba(255,255,255,.1);"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button class="cp-sp-small" id="cp-sp-send-not" style="flex:1;padding:8px;border-radius:6px;background:#1a73e8;border:none;color:#fff;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</button>
        <button class="cp-sp-small secondary" id="cp-sp-cancel-not" style="flex:1;padding:8px;border-radius:6px;background:#777;border:none;color:#fff;">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);

  const close=modal.querySelector(".cp-sp-close"),
        like=modal.querySelector("#cp-sp-like"),
        notify=modal.querySelector("#cp-sp-notify"),
        chat=modal.querySelector("#cp-sp-private"),
        box=modal.querySelector("#cp-sp-notify-box"),
        input=modal.querySelector("#cp-sp-notify-txt"),
        send=modal.querySelector("#cp-sp-send-not"),
        cancel=modal.querySelector("#cp-sp-cancel-not"),
        userNameSpan=modal.querySelector("#cp-user-name"),
        userPic = modal.querySelector("#cp-user-pic"),
        roomMsg = modal.querySelector("#cp-user-msg"),
        icoEl = modal.querySelector("#cp-user-ico"),
        bannerEl = modal.querySelector("#cp-user-banner"),
        roomBox = modal.querySelector("#cp-room-box");

  close.onclick = ()=>hide();
  cancel.onclick = ()=>{input.value="";hideNotify();};

  let target={userId:null,username:null};

  function show(id,name,bgImg){
    target.userId=id;
    target.username=name||"";

    const card=document.querySelector(".uid" + id);
    const topic=card?.querySelector(".u-topic")?.textContent.trim() || name || id;
    userNameSpan.textContent=topic;

    // ğŸŸ¢ Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ© + ØµÙˆØ±Ø© Ø§Ù„ØºØ±ÙØ©
    const roomId = userRoomMap[id];
    const roomName = roomNames[roomId] || "Ù„ÙŠØ³ ÙÙŠ ØºØ±ÙØ©";
    if(roomId){
      const roomEl = document.querySelector(".room.r"+roomId);
      const roomImg = roomEl?.querySelector(".u-pic")?.style.backgroundImage.replace(/^url\(["']?|["']?\)$/g,"").trim() || "";
      roomBox.innerHTML = `
        <div onclick="rjoin('${roomId}')">
          ${roomImg ? `<img src="${roomImg}">` : ""}
          ${roomName}
        </div>
      `;
    } else {
      roomBox.innerHTML = `<div style="color:#aaa;font-size:13px;">Ù„ÙŠØ³ ÙÙŠ ØºØ±ÙØ©</div>`;
    }

    const ico = card?.querySelector(".u-ico")?.src || "";
    if (ico) bannerEl.src = ico; else bannerEl.removeAttribute("src");
    const smallIco = card?.querySelector(".u-ico-small")?.src || "";
    if (smallIco) icoEl.src = smallIco; else icoEl.removeAttribute("src");

    userPic.style.backgroundImage = bgImg ? `url(${bgImg})` : "none";
    const innerPic = modal.querySelector("#cp-user-pic-inner");
    if (innerPic) innerPic.style.backgroundImage = bgImg ? `url(${bgImg})` : "none";

    const msg = card?.querySelector(".u-msg")?.textContent.trim() || "";
    roomMsg.textContent = msg;

    input.value = "";
    hideNotify();
    modal.style.display = "block";
  }

  function hide(){ modal.style.display="none"; target={userId:null,username:null}; }
  function showNotify(){ box.style.display="block"; }
  function hideNotify(){ box.style.display="none"; }

  like.onclick=()=>{
    const id=target.userId;
    if(!id) return;
    sendSocketPayload("ccvimn",{cmd:"like",id})
      ? (showToast("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨",3000),
         like.classList.add("active"),
         setTimeout(()=>like.classList.remove("active"),1500))
      : showToast("âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨",4000);
  };

  notify.onclick=()=>{ showNotify(); };
  send.onclick=()=>{
    const msg=input.value.trim(), id=target.userId;
    if(!msg) return alert("Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø£ÙˆÙ„Ø§Ù‹");
    sendSocketPayload("ccvimn",{cmd:"not",id,msg})
      ? (showToast("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡",3000),
         input.value="",
         hideNotify(),
         hide())
      : alert("âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
  };
  chat.onclick=()=>{
    const id=target.userId;
    if(id){
      if(typeof openw==="function"){
        openw(id,!0);
        hide();
      } else showToast("âŒ Ø¯Ø§Ù„Ø© openw ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
    }
  };

  window.cpShowProfile={show,hide};
}

document.querySelectorAll("div").forEach(bindProfileElement);
new MutationObserver(m=>{ m.forEach(n=>{ n.addedNodes.forEach(el=>{ if(el.nodeType===1){ bindProfileElement(el); el.querySelectorAll && el.querySelectorAll("div").forEach(bindProfileElement); } }); }); }).observe(document.body,{childList:true,subtree:true});
})();
